package com.lng.controller;

import java.util.ArrayList;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RestController;

import com.lng.pojo.SuperDep;
import com.lng.pojo.SuperUser;
import com.lng.service.DepartmentService;
import com.lng.service.SuperService;
import com.lng.tools.CurrentTime;
import com.lng.tools.MD5;
import com.lng.util.GenericResponse;
import com.lng.util.ResponseFormat;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiImplicitParams;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiResponse;
import io.swagger.annotations.ApiResponses;

@RestController
@Api(tags = "后台用户管理")
public class SuperController {
	
	@Autowired
	private SuperService ss;
	@Autowired
	private DepartmentService ds;
	
	@PostMapping("addUser")
	@ApiOperation(value = "增加用户",notes = "增加用户接口信息")
	@ApiResponses({@ApiResponse(code = 1000, message = "服务器错误"),@ApiResponse(code = 50003, message = "数据已存在")})
	@ApiImplicitParams({
		@ApiImplicitParam(name = "account", value = "用户账号", defaultValue = "wmk", required = true),
		@ApiImplicitParam(name = "password", value = "用户密码", defaultValue = "123456", required = true),
		@ApiImplicitParam(name = "realName", value = "用户姓名", defaultValue = "王杰", required = true),
		@ApiImplicitParam(name = "sex", value = "用户性别", defaultValue = "男", required = true),
		@ApiImplicitParam(name = "mobile", value = "手机号"),
		@ApiImplicitParam(name = "depId", value = "部门编号", required = true),
	})
	public GenericResponse addUser(String account,String password,String realName,String sex,String mobile,String depId) {
		Integer status = 200;
		String uId = "";
		try {
			if(ss.findInfoByOpt(account, "").size() > 0) {
				status = 20005;
			}else {
				SuperUser user = new SuperUser(account, new MD5().calcMD5(password), realName, sex, mobile,
						CurrentTime.getCurrentTime(), "", 0, 1);
				uId = ss.addOrUpUser(user);
				if(!uId.equals("")) {
					//绑定用户部门关系
					SuperDep sd = new SuperDep(ds.getEntityById(depId),user,CurrentTime.getCurrentTime());
					ss.addOrUpSuperDep(sd);
				}
			}
		} catch (Exception e) {
			// TODO: handle exception
			e.printStackTrace();
			status = 1000;
		}
		return ResponseFormat.retParam(status, uId);
	}
	
	@PutMapping("upUser")
	@ApiOperation(value = "修改指定用户的信息",notes = "修改用户信息，为空时不修改")
	@ApiResponses({@ApiResponse(code = 1000, message = "服务器错误"),@ApiResponse(code = 50001, message = "数据未找到")})
	@ApiImplicitParams({
		@ApiImplicitParam(name = "uId", value = "用户编号", required = true),
		@ApiImplicitParam(name = "password", value = "用户密码"),
		@ApiImplicitParam(name = "mobile", value = "手机号"),
		@ApiImplicitParam(name = "accountStatus", value = "账号状态")
	})
	public GenericResponse upUser(String uId,String password,String mobile,Integer accountStatus) {
		Integer status = 200;
		try {
			SuperUser user  = ss.getEntityById(uId);
			if(user != null) {
				if(password == null || password == "") {
					
				}else {
					user.setPassword(new MD5().calcMD5(password));
				}
				if(mobile == null || mobile.equals("")) {
					
				}else {
					user.setMobile(mobile);
				}
				if(accountStatus != null) {
					if(accountStatus.equals(1) || accountStatus.equals(0)) {
						user.setAccountStatus(accountStatus);
					}
				}
				ss.addOrUpUser(user);
			}else {
				status = 50001;
			}
		} catch (Exception e) {
			// TODO: handle exception
			e.printStackTrace();
			status = 1000;
		}
		return ResponseFormat.retParam(status, "");
	}
	
	@GetMapping("queryUser")
	@ApiOperation(value = "获取用户的信息列表",notes = "当uId不为空时，表示获取指定用户信息，当为空时，表示获取后台全部人员列表")
	@ApiResponses({@ApiResponse(code = 1000, message = "服务器错误"),@ApiResponse(code = 50001, message = "数据未找到")})
	@ApiImplicitParams({
		@ApiImplicitParam(name = "uId", value = "用户编号")
	})
	public GenericResponse queryUser(String uId) {
		Integer status = 200;
		List<SuperUser> spList = new ArrayList<SuperUser>();
		try {
			if(uId == null || uId == "") {
				spList = ss.findAllInfo();
			}else {
				SuperUser user  = ss.getEntityById(uId);
				if(user != null) {
					spList.add(user);
				}else {
					status = 50001;
				}
			}
		} catch (Exception e) {
			// TODO: handle exception
			e.printStackTrace();
			status = 1000;
		}
		return ResponseFormat.retParam(status, spList);
	}
}
